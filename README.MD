# ğŸš€ AstroZeit: Die ultimative kosmische Kaffeemaschinensteuerung (fÃ¼r Berlin!)

| ğŸ‡©ğŸ‡ª Deutsche Version | ğŸ‡¬ğŸ‡§ English Version (coming soon, maybe) |
| :--- | :--- |
| **Status:** LÃ¤uft! (Hoffentlich) | **Lizenz:** Freie Radikale |



---

## ğŸ§ Das Problem: Die Sonne ist unpÃ¼nktlich

Kennst du das? Du sitzt in Berlin, wartest auf den perfekten Moment fÃ¼r deinen *zweiten* Kaffee, aber die **Sonne** â˜€ï¸ hÃ¤lt sich einfach nicht an deinen Zeitplan. Mal geht sie *nautisch* unter, mal *astronomisch*. Wer soll da noch durchblicken?!

**Die LÃ¶sung:** Unser kleines, aber **mÃ¤chtiges** iobroker-Skript, das die Himmelsmechanik zwingt, in DEIN Smart Home einzuziehen!

---

## ğŸŒŒ Was dieses Skript tut (und was nicht)

### ğŸ¥‡ Was es kann:

* **Sonnenzeiten berechnen:** Von `sunrise` bis `astronomicalDusk` â€“ wir haben das volle Himmelsprogramm!
* **Datenpunkte erstellen:** SorgfÃ¤ltig sortiert unter `0_userdata.0.sonnenzeit`. Jetzt weiÃŸ deine Logik, wann die *goldene Stunde* fÃ¼r Selfies ist.
* **Doppelte AusfÃ¼hrung:** Es speichert die Zeiten sowohl als **Unix Timestamp** (fÃ¼r die Nerds) als auch als **HH:MM String** (fÃ¼r die, die nur wissen wollen, wann es dunkel wird).
* **100% Berlin-zentriert:** Mit `52.52` und `13.405` sind wir so lokal, es riecht fast nach DÃ¶ner.
    *(P.S. Wenn du nicht in Berlin wohnst: **PECH GEHABT!** Oder Ã¤ndere die Koordinaten â€“ aber pssst, das ist ein Geheimtipp).*

### ğŸ¥ˆ Was es NICHT kann:

* **Kaffee kochen:** Aber es liefert dir die genaue Zeit, wann du am besten damit anfangen solltest.
* **Das Wetter vorhersagen:** Die Sonne ist *da*, der Regen auch.
* **Deine iobroker-Instanz reparieren:** Wenn es abstÃ¼rzt, war's die Schwerkraft.

---

## ğŸ› ï¸ Installation & Inbetriebnahme (Easy Peasy, Astro-Squeezy)

1.  **Stelle sicher, dass iobroker lÃ¤uft.** (Ein Muss, sonst wird's nix mit der Heimautomation.)
2.  **Ã–ffne den JavaScript-Adapter.** (Sollte klar sein.)
3.  **FÃ¼ge das `SunCalc`-Modul hinzu.** (Ohne Sonnenuhr keine Sonnenzeit. Meistens ist es aber schon da â€“ *Gott sei Dank!*)
4.  **Kopiere den gesamten Code** in ein neues Skript (nenn es `AstroZeit.js` oder `Chefkoch_der_Sonnenzeiten`).
5.  **Speichern und starten.**
6.  **Schau in den Log:** Wenn da steht: `"Sonnenzeiten wurden unter 0_userdata.0.sonnenzeit erstellt/aktualisiert."`, dann hast du die Himmelsmechanik besiegt!

---

## ğŸ“œ Der Code (Die Magie geschieht in den Tiefen des JS)

```javascript
// iobroker Script: Sonnenzeiten berechnen und Datenpunkte erstellen
// Zielverzeichnis: 0_userdata.0.sonnenzeit

// 1ï¸âƒ£ Koordinaten fÃ¼r Berlin
const latitude = 52.52;
const longitude = 13.405;

// 2ï¸âƒ£ SunCalc laden (in iobroker ist sie meist verfÃ¼gbar, ansonsten Ã¼ber javascript-Adapter als npm-Modul)
const SunCalc = require('suncalc');

// 3ï¸âƒ£ Aktuelles Datum
const now = new Date();

// 4ï¸âƒ£ Sonnenzeiten berechnen
const times = SunCalc.getTimes(now, latitude, longitude);

// 5ï¸âƒ£ Funktion zum Formatieren als HH:MM
function formatTime(date) {
    const h = date.getHours().toString().padStart(2,'0');
    const m = date.getMinutes().toString().padStart(2,'0');
    return `${h}:${m}`;
}

// 6ï¸âƒ£ Datenpunkte erstellen / aktualisieren
const basePath = '0_userdata.0.sonnenzeit';

// Definition der Datenpunkte
const dpList = {
    sunrise: times.sunrise,
    sunset: times.sunset,
    solarNoon: times.solarNoon,
    dawn: times.dawn,                // BÃ¼rgerliche DÃ¤mmerung morgens
    dusk: times.dusk,                // BÃ¼rgerliche DÃ¤mmerung abends
    nauticalDawn: times.nauticalDawn,
    nauticalDusk: times.nauticalDusk,
    astronomicalDawn: times.nightEnd,
    astronomicalDusk: times.night,
    goldenHourMorning: times.goldenHourEnd,
    goldenHourEvening: times.goldenHour
};

// 7ï¸âƒ£ Schleife Ã¼ber alle Datenpunkte
for (let key in dpList) {
    const date = dpList[key];
    if (!date) continue; // falls SunCalc keinen Wert liefert
    
    // Pfad fÃ¼r den Datenpunkt
    const dpPathTimestamp = `${basePath}.${key}_timestamp`;
    const dpPathString = `${basePath}.${key}_hhmm`;

    // Datenpunkt als Zahl (Unix Timestamp in Sekunden)
    if (!existsState(dpPathTimestamp)) {
        createState(dpPathTimestamp, Math.floor(date.getTime()/1000), { type: 'number', read: true, write: false });
    } else {
        setState(dpPathTimestamp, Math.floor(date.getTime()/1000), true);
    }

    // Datenpunkt als String HH:MM
    if (!existsState(dpPathString)) {
        createState(dpPathString, formatTime(date), { type: 'string', read: true, write: false });
    } else {
        setState(dpPathString, formatTime(date), true);
    }
}

// 8ï¸âƒ£ Info in Log
log('Sonnenzeiten wurden unter 0_userdata.0.sonnenzeit erstellt/aktualisiert.');


ğŸ‘¨â€ğŸ”¬ About: Der SchÃ¶pfer und das Chaos

AstroZeit ist ein Nebenprodukt der verzweifelten Suche nach dem perfekten Moment, um die RollÃ¤den zu schlieÃŸen, damit die Nachbarn nicht das Chaos im Wohnzimmer sehen. Entwickelt in einer schlaflosen Nacht, in der die Sonne einfach nicht wusste, ob sie auf- oder untergehen soll.

Philosophie: Warum raten, wann die nauticalDusk ist, wenn man es auch wissen kann? Die Menschheit ist auf dem Mond gelandet â€“ wir kÃ¶nnen auch die DÃ¤mmerung in einem iobroker-Datenpunkt erfassen!

Disclaimer: FÃ¼r Fehler in der Himmelsmechanik oder falsche Sonnenzeiten aufgrund von Zeitzonenwechseln lehnen wir jede Verantwortung ab. Frag die Sonne, nicht den Coder! ğŸ¤ª